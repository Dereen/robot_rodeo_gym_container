Bootstrap: docker
FROM: ghcr.io/sloretz/ros:noetic-simulators-osrf

%help
   This is a custom Apptainer image for CTU-VRAS.

%environment
    # Source the custom bash environment
    if [ -f /.env/bashrc.sh ]; then
        source /.env/bashrc.sh
        source /.env/bash_prompt.sh
        source /.env/bash_aliases.sh
        source /.env/bash_functions.sh
    fi

%setup
    mkdir -p ${APPTAINER_ROOTFS}/.env
    mkdir -p ${APPTAINER_ROOTFS}/.tmp
    mkdir -p ${APPTAINER_ROOTFS}/.config
    mkdir -p ${APPTAINER_ROOTFS}/.custom_commands

%files
    ../env/* /.env/
    ../config/* /.config/
    ../commands/* /.custom_commands/

%environment
    export PATH="/.custom_commands:${PATH}"
    export XDG_RUNTIME_DIR=$(mktemp -d)  # This fixes running VSCode, PyCharm etc. because /run/user/$(id -u) is not bind-mounted by default.

%post
    BASHRC="/.env/bashrc.sh"
    TMUX_CONF="/.env/tmux.conf"
    APT_PACKAGES="/.config/packages.apt"
    PIP_PACKAGES="/.config/packages.pip"

    # Install apt packages
    apt-get update
    DEBIAN_FRONTEND=noninteractive xargs -a $APT_PACKAGES apt-get install -y

    # Install pip packages
    pip3 install -r $PIP_PACKAGES

    # Make all custom commands executable
    chmod +x /.custom_commands/*

    # Configure tmux and bash
    ln -fs $BASHRC /etc/bash.bashrc
    ln -fs $TMUX_CONF /etc/tmux.conf
